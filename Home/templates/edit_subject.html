{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Subject{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h1>Edit Subject</h1>
            <p class="text-muted">Update subject information and images</p>
        </div>

        <form method="post" enctype="multipart/form-data" class="form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="{{ subject_form.customer.id_for_label }}">Customer Name</label>
                {{ subject_form.customer }}
            </div>

            <div class="form-group">
                <label for="{{ subject_form.price.id_for_label }}">Price ($)</label>
                {{ subject_form.price }}
            </div>

            <div class="form-group">
                <label for="{{ subject_form.comment.id_for_label }}">Description</label>
                {{ subject_form.comment }}
            </div>

            <div class="form-group">
                <label for="{{ subject_form.date_limit.id_for_label }}">Deadline</label>
                {{ subject_form.date_limit }}
            </div>

            <div class="form-group">
                <label>Images</label>
                <div class="image-upload-container" id="dropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                    <p class="mb-2">Drag and drop your images here</p>
                    <p class="text-muted small">or</p>
                    <input type="file" name="multiple_images" id="multiple_images" multiple accept="image/*" class="form-control" style="display: none;">
                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('multiple_images').click()">
                        Select Files
                    </button>
                </div>
                <div id="image-preview-container" class="mt-3">
                    {% for image in subject.images.all %}
                        <div class="image-preview" id="image-{{ image.id }}">
                            <img src="{{ image.image.url }}" alt="Image">
                            <button type="button" class="delete-btn" onclick="deleteImage({{ image.id }})">Ã—</button>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-actions">
                <a href="{% url 'image_list' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('multiple_images').addEventListener('change', function(event) {
        const previewContainer = document.getElementById('image-preview-container');
        // previewContainer.innerHTML = ''; // Clear existing previews

        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function(e) {
                const imageContainer = document.createElement('div');
                imageContainer.classList.add('image-preview');
                imageContainer.style.display = 'inline-block';
                imageContainer.style.marginRight = 10;
                imageContainer.style.position = 'relative';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = 100; // Adjust size as needed
                img.style.height = 100;
                img.style.objectFit = 'cover';
                img.style.borderRadius = 5;
                imageContainer.appendChild(img);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = 'X';
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.style.position = 'absolute';
                deleteButton.style.top = 0;
                deleteButton.style.right = 0;
                deleteButton.addEventListener('click', function() {
                    imageContainer.remove();
                });
                imageContainer.appendChild(deleteButton);

                previewContainer.appendChild(imageContainer);
            }

            reader.readAsDataURL(file);
        }
    });

    function deleteImage(imageId) {
        $.ajax({
            url: '/delete_image_ajax/' + imageId + '/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Remove the image preview from the page
                    $('#image-' + imageId).remove();
                } else {
                    alert('Error deleting image.');
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", status, error);
                alert('AJAX error deleting image.');
            }
        });
    }
</script>

<style>
    .image-preview {
        display: inline-block;
        margin-right: 10px;
        position: relative;
    }

    .image-preview img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 5px;
    }

    .image-preview button {
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .x-style{
        background: red;
        border-radius: 2px;
        font-size: 10px;
        padding: 5px;
        right: 0px;
        top: 0px;
    }
</style>
{% endblock %}
